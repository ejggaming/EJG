name: Deploy Backend to GCP Cloud Run

on:
    push:
        branches:
            - develop
    workflow_dispatch:

env:
    PROJECT_ID: ejg-api-dev
    REGION: us-central1
    SERVICE_NAME: ejg-api-backend-dev
    ARTIFACT_REPOSITORY: backend
    IMAGE_NAME: backend-api

jobs:
    deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write

        steps:
            - name: Checkout source
              uses: actions/checkout@v4

      - name: Validate GCP auth config
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_WIF_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        run: |
          if [ -n "${GCP_WIF_PROVIDER}" ] && [ -n "${GCP_SERVICE_ACCOUNT}" ]; then
            echo "Using Workload Identity auth."
            exit 0
          fi

          if [ -n "${GCP_SA_KEY}" ]; then
            echo "Using service account key auth."
            exit 0
          fi

          echo "Missing GCP auth secrets."
          echo "Set GCP_SA_KEY OR set both GCP_WORKLOAD_IDENTITY_PROVIDER and GCP_SERVICE_ACCOUNT."
          exit 1

      - name: Normalize GCP service account key
        id: sa_key
        if: ${{ secrets.GCP_SA_KEY != '' && !(secrets.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT != '') }}
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
                  RAW_KEY="${GCP_SA_KEY}"
                  JSON_KEY=""

                  if printf '%s' "${RAW_KEY}" | jq -e . >/dev/null 2>&1; then
                    JSON_KEY="${RAW_KEY}"
                  else
                    DECODED_KEY="$(printf '%s' "${RAW_KEY}" | base64 --decode 2>/dev/null || true)"
                    if [ -n "${DECODED_KEY}" ] && printf '%s' "${DECODED_KEY}" | jq -e . >/dev/null 2>&1; then
                      JSON_KEY="${DECODED_KEY}"
                    else
                      echo "GCP_SA_KEY is invalid. Use raw service-account JSON or base64-encoded JSON."
                      exit 1
                    fi
                  fi

                  {
                    echo "credentials_json<<EOF"
                    printf '%s\n' "${JSON_KEY}"
                    echo "EOF"
                  } >> "${GITHUB_OUTPUT}"

      - name: Authenticate to Google Cloud (Service Account Key)
        if: ${{ secrets.GCP_SA_KEY != '' && !(secrets.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT != '') }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ steps.sa_key.outputs.credentials_json }}

      - name: Authenticate to Google Cloud (Workload Identity)
        if: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT != '' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

            - name: Setup gcloud CLI
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ env.PROJECT_ID }}

            - name: Configure Docker for Artifact Registry
              run: gcloud auth configure-docker "${{ env.REGION }}-docker.pkg.dev" --quiet

            - name: Ensure Artifact Registry repository exists
              run: |
                  gcloud artifacts repositories describe "${{ env.ARTIFACT_REPOSITORY }}" \
                    --location "${{ env.REGION }}" >/dev/null 2>&1 || \
                  gcloud artifacts repositories create "${{ env.ARTIFACT_REPOSITORY }}" \
                    --repository-format docker \
                    --location "${{ env.REGION }}" \
                    --description "Docker images for backend service"

            - name: Build Docker image
              run: |
                  IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
                  echo "IMAGE_URI=${IMAGE_URI}" >> "${GITHUB_ENV}"
                  docker build -t "${IMAGE_URI}" .

            - name: Push Docker image
              run: docker push "${IMAGE_URI}"

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy "${{ env.SERVICE_NAME }}" \
                    --project "${{ env.PROJECT_ID }}" \
                    --region "${{ env.REGION }}" \
                    --platform managed \
                    --image "${IMAGE_URI}" \
                    --allow-unauthenticated \
                    --update-env-vars NODE_ENV=production

            - name: Print service URL
              run: |
                  URL="$(gcloud run services describe "${{ env.SERVICE_NAME }}" --project "${{ env.PROJECT_ID }}" --region "${{ env.REGION }}" --format='value(status.url)')"
                  echo "Service URL: ${URL}"
